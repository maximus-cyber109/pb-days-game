<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#6366f1">
  <title>PB DAYS: Game of Crowns</title>
  
  <!-- CDN Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
  
  <style>
    /* ===== INLINE CSS ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0f172a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      color: white;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1f2937, #374151);
      border: 2px solid rgba(99, 102, 241, 0.5);
      border-radius: 20px;
      padding: 50px 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }
    
    .modal-content h2 {
      font-size: 32px;
      margin-bottom: 15px;
    }
    
    #email-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 30px;
    }
    
    #email-input {
      padding: 18px;
      font-size: 16px;
      border: 2px solid rgba(99, 102, 241, 0.3);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      outline: none;
    }
    
    #email-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    
    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error */
    .error {
      background: white;
      color: #333;
      padding: 60px 40px;
      border-radius: 20px;
      max-width: 500px;
      margin: 100px auto;
      text-align: center;
    }
    
    .error-icon { font-size: 64px; margin-bottom: 20px; }
    .error h2 { color: #dc2626; margin-bottom: 15px; }
    
    /* Header */
    .header-section {
      text-align: center;
      margin-bottom: 40px;
      padding-top: 40px;
    }
    
    h1 {
      font-size: clamp(2rem, 5vw, 3.5rem);
      margin-bottom: 15px;
    }
    
    .subtitle {
      font-size: clamp(1rem, 3vw, 1.5rem);
      color: rgba(255, 255, 255, 0.85);
    }
    
    /* Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 40px;
      margin: 60px 0;
      padding: 20px;
    }
    
    .card {
      perspective: 1000px;
      width: 100%;
      max-width: 320px;
      height: 450px;
      margin: 0 auto;
      opacity: 0;
    }
    
    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    
    .card-back, .card-front {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
    }
    
    .card-back {
      background: linear-gradient(135deg, #1f2937, #374151);
    }
    
    .card-front {
      transform: rotateY(180deg);
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      position: relative;
    }
    
    .card-back img, .card-front img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .rare-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      z-index: 10;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .card-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
      padding: 30px 20px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }
    
    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(99, 102, 241, 0.6);
    }
    
    .btn-large {
      padding: 20px 50px;
      font-size: 18px;
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 12px 30px;
      border-radius: 10px;
      margin-top: 15px;
      cursor: pointer;
    }
    
    /* Continue Section */
    .continue-section {
      text-align: center;
      margin: 60px 0;
    }
    
    .hint-text {
      margin-top: 20px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    /* Value Reward */
    .value-reward-message {
      background: rgba(251, 191, 36, 0.2);
      border: 2px solid rgba(251, 191, 36, 0.5);
      border-radius: 20px;
      padding: 40px;
      margin: 40px auto;
      max-width: 500px;
    }
    
    .value-icon { font-size: 64px; margin-bottom: 20px; }
    .value-amount {
      font-size: 48px;
      font-weight: bold;
      color: #fbbf24;
      margin-top: 15px;
    }
    
    /* Sound Toggle */
    .sound-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(99, 102, 241, 0.9);
      border: none;
      font-size: 28px;
      cursor: pointer;
      z-index: 1000;
    }
    
    /* Utility */
    .hidden { display: none !important; }
    
    /* Mobile */
    @media (max-width: 768px) {
      .cards-grid { grid-template-columns: 1fr; }
      .card { height: 400px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Email Modal -->
    <div id="email-modal" class="modal hidden">
      <div class="modal-content">
        <h2>üé¥ Enter Your Email</h2>
        <p>Please enter your email to view your rewards</p>
        <form id="email-form" onsubmit="submitEmail(event)">
          <input type="email" id="email-input" placeholder="your@email.com" required>
          <button type="submit" class="btn-primary">Continue</button>
        </form>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Processing your rewards...</p>
    </div>

    <!-- Error -->
    <div id="error" class="error hidden">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h2>Oops! Something went wrong</h2>
      <p id="error-message"></p>
      <button class="btn-primary" onclick="location.reload()">Try Again</button>
    </div>

    <!-- Rewards -->
    <div id="rewards-container" class="hidden">
      <div class="header-section">
        <h1>üé¥ Your Rewards Await!</h1>
        <p class="subtitle" id="card-count"></p>
      </div>
      <div id="cards-grid" class="cards-grid"></div>
      <div id="continue-btn" class="continue-section hidden">
        <button class="btn-primary btn-large" onclick="goToRedemption()">
          View My Collection & Redeem ‚Üí
        </button>
        <p class="hint-text">You can come back anytime</p>
      </div>
    </div>

    <!-- Sound Toggle -->
    <button id="sound-toggle" class="sound-toggle" onclick="toggleSound()">
      <span id="sound-icon">üîä</span>
    </button>
  </div>

  <script>
    // ========== CONFIGURATION ==========
    const CONFIG = {
      supabaseUrl: '${VITE_SUPABASE_URL}',
      supabaseKey: '${VITE_SUPABASE_KEY}',
      apiUrl: window.location.origin + '/.netlify/functions',
      // GitHub raw URLs for images
      cardImagesBaseUrl: 'https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/images/cards',
      cardBackUrl: 'https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/images/card-back.png'
    };

    // ========== GLOBAL VARIABLES ==========
    let currentEmail = null;
    let soundEnabled = true;
    let soundManager = null;
    let supabase = null;

    // ========== SUPABASE INIT ==========
    function initSupabase() {
      supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
      console.log('Supabase initialized');
    }

    // ========== SOUND MANAGER ==========
    function initSounds() {
      if (!window.Howl || soundManager) return;
      try {
        soundManager = {
          muted: false,
          toggleMute: function() {
            this.muted = !this.muted;
          }
        };
      } catch (error) {
        console.warn('Sound init failed:', error);
      }
    }

    // ========== REWARD LOGIC ==========
    function calculateProductReward(product, segmentCardMap) {
      const price = parseFloat(product.product_price);
      const segmentCode = product.segment_code;
      const sku = product.p_code;

      if (price === 0) return { type: 'none' };

      if (price > 0 && price < 1000) {
        return { type: 'value', amount: price * 0.01, sku, price };
      }

      if (price >= 1000) {
        let cardName, isRare = false;

        if (segmentCode === 'HD') {
          cardName = price > 10000 ? 'Device-Keeper' : 'Tooth-Tyrant';
          isRare = price > 10000;
        } else if (segmentCode === 'IC') {
          cardName = segmentCardMap[segmentCode] || 'LensWarden';
          isRare = true;
        } else {
          cardName = segmentCardMap[segmentCode] || 'Tooth-Tyrant';
          isRare = price > 10000;
        }

        return { type: 'card', cardName, segmentCode, isRare, sku, price };
      }

      return { type: 'none' };
    }

    function calculateOrderRewards(products, segmentCardMap) {
      const cards = [], valueRewards = [];

      products.forEach(product => {
        const reward = calculateProductReward(product, segmentCardMap);
        if (reward.type === 'card') cards.push(reward);
        else if (reward.type === 'value') valueRewards.push(reward);
      });

      cards.sort((a, b) => {
        if (a.isRare && !b.isRare) return -1;
        if (!a.isRare && b.isRare) return 1;
        return 0;
      });

      return {
        cards,
        valueRewards,
        totalCards: cards.length,
        totalRareCards: cards.filter(c => c.isRare).length,
        totalValueReward: valueRewards.reduce((sum, r) => sum + r.amount, 0)
      };
    }

    // ========== DATABASE FUNCTIONS ==========
    async function getSegmentCardMapping() {
      const { data, error } = await supabase
        .from('segment_cards')
        .select('segment_code, card_name');
      if (error) throw error;
      const map = {};
      data.forEach(row => map[row.segment_code] = row.card_name);
      return map;
    }

    async function getProductsBySKUs(skus) {
      const { data, error } = await supabase
        .from('products')
        .select('p_code, segment_code, product_price')
        .in('p_code', skus);
      if (error) throw error;
      return data || [];
    }

    async function saveOrderRewards(orderData, rewards) {
      try {
        const { error: orderError } = await supabase
          .from('orders')
          .insert({
            order_id: orderData.orderId,
            customer_email: orderData.email,
            grand_total: orderData.total,
            order_date: new Date().toISOString()
          });

        if (orderError) {
          if (orderError.code === '23505') {
            return { success: false, error: 'Order already claimed!', duplicate: true };
          }
          throw orderError;
        }

        if (rewards.cards.length > 0) {
          const cardsToInsert = rewards.cards.map(card => ({
            order_id: orderData.orderId,
            customer_email: orderData.email,
            card_name: card.cardName,
            segment_code: card.segmentCode,
            is_rare: card.isRare,
            product_sku: card.sku,
            product_price: card.price
          }));
          await supabase.from('cards_earned').insert(cardsToInsert);
        }

        if (rewards.valueRewards.length > 0) {
          const valueToInsert = rewards.valueRewards.map(r => ({
            order_id: orderData.orderId,
            customer_email: orderData.email,
            product_sku: r.sku,
            product_price: r.price,
            reward_amount: r.amount
          }));
          await supabase.from('value_rewards').insert(valueToInsert);
        }

        return { success: true };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }

    async function checkOrderClaimed(orderId) {
      const { data } = await supabase
        .from('orders')
        .select('order_id')
        .eq('order_id', orderId)
        .single();
      return data !== null;
    }

    // ========== ANIMATIONS ==========
    function createCardElement(card) {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card';
      const cardImageUrl = `${CONFIG.cardImagesBaseUrl}/${card.cardName}.png`;
      const cardBackUrl = CONFIG.cardBackUrl;
      
      cardDiv.innerHTML = `
        <div class="card-inner">
          <div class="card-back">
            <img src="${cardBackUrl}" alt="Card Back">
          </div>
          <div class="card-front">
            <img src="${cardImageUrl}" alt="${card.cardName}">
            ${card.isRare ? '<span class="rare-badge">‚≠ê RARE</span>' : ''}
            <div class="card-name">${card.cardName}</div>
          </div>
        </div>
      `;
      return cardDiv;
    }

    function animateCardReveal(cardElement, isRare, delay) {
      setTimeout(() => {
        anime({
          targets: cardElement,
          rotateY: [0, 180],
          duration: 600,
          easing: 'easeInOutQuad',
          complete: () => cardElement.classList.add('flipped')
        });
        anime({
          targets: cardElement,
          scale: [0.5, 1],
          opacity: [0, 1],
          duration: 500,
          easing: 'easeOutElastic(1, .5)'
        });
      }, delay);
    }

    function revealAllCards(cards, container) {
      cards.forEach((card, index) => {
        const cardEl = createCardElement(card);
        container.appendChild(cardEl);
        animateCardReveal(cardEl, card.isRare, index * 1500);
      });
    }

    // ========== UI FUNCTIONS ==========
    function checkEmail() {
      const params = new URLSearchParams(window.location.search);
      const emailParam = params.get('email');

      if (emailParam && emailParam.trim()) {
        currentEmail = emailParam.trim().toLowerCase();
        document.getElementById('email-modal').classList.add('hidden');
        init();
      } else {
        document.getElementById('email-modal').classList.remove('hidden');
        document.getElementById('email-input').focus();
      }
    }

    function submitEmail(event) {
      event.preventDefault();
      currentEmail = document.getElementById('email-input').value.trim().toLowerCase();
      if (currentEmail) {
        document.getElementById('email-modal').classList.add('hidden');
        const newUrl = `${window.location.pathname}?email=${encodeURIComponent(currentEmail)}`;
        window.history.pushState({}, '', newUrl);
        init();
      }
    }

    async function init() {
      try {
        if (!currentEmail) throw new Error('Email required');

        document.getElementById('loading').classList.remove('hidden');
        initSounds();
        initSupabase();

        const orderResponse = await fetch(`${CONFIG.apiUrl}/magento-fetch`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail })
        });

        if (!orderResponse.ok) throw new Error(`Server error: ${orderResponse.status}`);
        const orderData = await orderResponse.json();
        if (!orderData.success) throw new Error(orderData.error);

        const alreadyClaimed = await checkOrderClaimed(orderData.order.id);
        if (alreadyClaimed) {
          window.location.href = `/redemption.html?email=${currentEmail}`;
          return;
        }

        const segmentCardMap = await getSegmentCardMapping();
        const skus = orderData.order.items.map(item => item.sku);
        const products = await getProductsBySKUs(skus);

        if (!products || products.length === 0) {
          throw new Error('No products found');
        }

        const rewards = calculateOrderRewards(products, segmentCardMap);

        const saveResult = await saveOrderRewards({
          orderId: orderData.order.id,
          email: currentEmail,
          total: orderData.order.grand_total,
          customerName: orderData.customer?.firstname || 'Customer'
        }, rewards);

        if (!saveResult.success) {
          if (saveResult.duplicate) {
            window.location.href = `/redemption.html?email=${currentEmail}`;
            return;
          }
          throw new Error(saveResult.error);
        }

        showRewards(rewards);

      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
      }
    }

    function showRewards(rewards) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('rewards-container').classList.remove('hidden');

      if (rewards.cards.length === 0 && rewards.totalValueReward > 0) {
        document.getElementById('card-count').innerHTML = `
          <div class="value-reward-message">
            <div class="value-icon">üí∞</div>
            <p>You've earned PB Cash!</p>
            <p class="value-amount">‚Çπ${rewards.totalValueReward.toFixed(2)}</p>
          </div>
        `;
        document.getElementById('continue-btn').classList.remove('hidden');
        return;
      }

      const cardText = rewards.totalCards === 1 ? 'card' : 'cards';
      const rareText = rewards.totalRareCards > 0 ? ` (${rewards.totalRareCards} rare ‚≠ê)` : '';
      document.getElementById('card-count').textContent = `Revealing ${rewards.totalCards} ${cardText}${rareText}...`;

      const grid = document.getElementById('cards-grid');
      revealAllCards(rewards.cards, grid);

      setTimeout(() => {
        document.getElementById('continue-btn').classList.remove('hidden');
      }, rewards.cards.length * 1500 + 2000);
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('email-modal').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
    }

    function goToRedemption() {
      if (currentEmail) {
        window.location.href = `/redemption.html?email=${currentEmail}`;
      }
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      if (soundManager) soundManager.toggleMute();
      document.getElementById('sound-icon').textContent = soundEnabled ? 'üîä' : 'üîá';
    }

    // ========== START ==========
    window.addEventListener('DOMContentLoaded', checkEmail);
  </script>
</body>
</html>
